# 杭州保障房项目 - 使用说明

## 项目概述

本项目是一个基于现代技术栈的全栈Web应用：
- **前端**: Vue 3 + TypeScript + Vite
- **后端**: Fastify + TypeScript + PostgreSQL + Redis
- **部署**: Docker + Docker Compose + Nginx

## 系统要求

### 本地开发环境
- **Docker**: 版本 20.10 或更高
- **Docker Compose**: 版本 2.0 或更高
- **Node.js**: 版本 18 或更高
- **pnpm**: 包管理器

### 远程部署环境
- **服务器**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **内存**: 最低 2GB，推荐 4GB+
- **存储**: 最低 20GB 可用空间
- **SSH**: 密钥认证配置

## 核心脚本

### 1. 本地开发脚本 (`local-dev.sh`)

用于本地开发环境的管理。

```bash
# 给脚本执行权限
chmod +x local-dev.sh

# 启动开发环境
./local-dev.sh start

# 查看服务状态
./local-dev.sh status

# 查看日志
./local-dev.sh logs

# 初始化数据库
./local-dev.sh db-init

# 停止开发环境
./local-dev.sh stop
```

**完整命令列表：**
- `start` - 启动本地开发环境
- `stop` - 停止本地开发环境
- `restart` - 重启本地开发环境
- `logs` - 查看开发环境日志
- `status` - 显示开发环境状态
- `build` - 构建开发环境镜像
- `db-init` - 初始化数据库
- `db-reset` - 重置数据库（删除所有数据）
- `clean` - 清理开发环境资源
- `help` - 显示帮助信息

**开发环境服务地址：**
- 后端API: http://localhost:3001
- 前端应用: http://localhost:3000
- 健康检查: http://localhost:3001/health
- API文档: http://localhost:3001/docs
- 数据库: postgresql://house_user:house_pass_2024@localhost:5432/house_db
- Redis: redis://localhost:6379

### 2. 远程部署脚本 (`remote-deploy.sh`)

用于部署到远程服务器。

```bash
# 给脚本执行权限
chmod +x remote-deploy.sh

# 首次完整部署
./remote-deploy.sh deploy

# 日常代码更新
./remote-deploy.sh update

# 查看服务状态
./remote-deploy.sh status

# 查看服务日志
./remote-deploy.sh logs
```

**完整命令列表：**
- `deploy` - 完整部署（首次部署使用）
- `update` - 快速更新（日常更新使用）
- `start` - 启动服务
- `stop` - 停止服务
- `status` - 查看服务状态
- `logs` - 查看服务日志
- `help` - 显示帮助信息

**生产环境服务地址：**
- 前端: http://101.43.35.163
- 后端API: http://101.43.35.163:3001
- 健康检查: http://101.43.35.163:3001/health

## 快速开始

### 本地开发

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd house
   ```

2. **启动开发环境**
   ```bash
   ./local-dev.sh start
   ```

3. **初始化数据库**
   ```bash
   ./local-dev.sh db-init
   ```

4. **访问应用**
   - 前端: http://localhost:3000
   - 后端API: http://localhost:3001

### 远程部署

1. **配置SSH密钥**
   ```bash
   # 生成SSH密钥（如果没有）
   ssh-keygen -t rsa -b 4096 -C "your-email@example.com"
   
   # 复制公钥到服务器
   ssh-copy-id -p 2222 ubuntu@101.43.35.163
   ```

2. **首次部署**
   ```bash
   ./remote-deploy.sh deploy
   ```

3. **日常更新**
   ```bash
   ./remote-deploy.sh update
   ```

## 项目结构

```
house/
├── local-dev.sh              # 本地开发脚本
├── remote-deploy.sh          # 远程部署脚本
├── docker-compose.yml        # 生产环境 Docker 配置
├── docker-compose.dev.yml    # 开发环境 Docker 配置
├── house-server/             # 后端服务
│   ├── src/                  # 源代码
│   ├── migrations/           # 数据库迁移文件
│   ├── seeds/                # 种子数据
│   ├── Dockerfile            # 生产环境镜像
│   ├── Dockerfile.dev        # 开发环境镜像
│   └── package.json
├── house-web/                # 前端服务
│   ├── src/
│   ├── Dockerfile
│   └── package.json
└── nginx/                    # Nginx 配置
    ├── nginx.conf
    └── conf.d/
```

## 数据库管理

### 本地数据库

- **连接信息**: postgresql://house_user:house_pass_2024@localhost:5432/house_db
- **管理工具**: 推荐使用 DBeaver、pgAdmin 或 TablePlus
- **初始化**: `./local-dev.sh db-init`
- **重置**: `./local-dev.sh db-reset`

### 远程数据库

- **连接信息**: postgresql://postgres:password@101.43.35.163:5432/house_db
- **外网访问**: 已配置，可直接连接
- **备份**: 通过服务器上的脚本进行

## 常见问题

### 1. 端口占用

如果遇到端口占用问题：
```bash
# 查看端口占用
lsof -i :5432
lsof -i :3001

# 停止相关服务
./local-dev.sh stop
```

### 2. Docker 权限问题

```bash
# 将用户添加到 docker 组
sudo usermod -aG docker $USER

# 重新登录或重启终端
```

### 3. 数据库连接失败

```bash
# 检查数据库服务状态
./local-dev.sh status

# 重启数据库服务
./local-dev.sh restart

# 重新初始化数据库
./local-dev.sh db-reset
```

### 4. 远程部署失败

```bash
# 检查SSH连接
ssh -p 2222 ubuntu@101.43.35.163

# 检查服务器磁盘空间
df -h

# 查看远程服务日志
./remote-deploy.sh logs
```

## 开发工作流

### 日常开发

1. 启动本地环境：`./local-dev.sh start`
2. 进行代码开发
3. 查看日志调试：`./local-dev.sh logs`
4. 提交代码到Git
5. 部署到远程：`./remote-deploy.sh update`

### 新功能开发

1. 创建新分支
2. 本地开发和测试
3. 如需重置数据库：`./local-dev.sh db-reset`
4. 合并到主分支
5. 部署到生产环境

## 监控和维护

### 服务监控

```bash
# 本地环境状态
./local-dev.sh status

# 远程环境状态
./remote-deploy.sh status

# 查看日志
./local-dev.sh logs      # 本地
./remote-deploy.sh logs  # 远程
```

### 资源清理

```bash
# 清理本地开发环境
./local-dev.sh clean

# 清理Docker资源
docker system prune -f
```

## 技术支持

如遇到问题，请按以下顺序排查：

1. 查看本文档的常见问题部分
2. 检查服务日志：`./local-dev.sh logs` 或 `./remote-deploy.sh logs`
3. 检查Docker服务状态：`docker ps`
4. 重启相关服务
5. 联系技术团队

---

**项目状态**: 开发完成，已部署运行  
**最后更新**: 2025年8月30日  
**维护团队**: House Development Team