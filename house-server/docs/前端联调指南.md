# 前端小程序联调指南

## 快速开始

### 1. 服务器信息
- **API地址**: `http://localhost:3000`
- **在线文档**: `http://localhost:3000/docs`
- **数据库管理**: `http://localhost:8080` (Adminer)

### 2. 启动服务
```bash
# 在项目根目录执行
docker-compose up -d  # 启动数据库
npm run dev          # 启动API服务
```

## 核心接口使用

### 🔐 用户登录
```javascript
// 微信登录
wx.login({
  success: (res) => {
    wx.request({
      url: 'http://localhost:3000/auth/wechat/login',
      method: 'POST',
      data: {
        code: res.code,
        nickname: '用户昵称',
        avatar: '头像URL'
      },
      success: (loginRes) => {
        // 保存token
        wx.setStorageSync('token', loginRes.data.data.token)
        wx.setStorageSync('userInfo', loginRes.data.data.user)
      }
    })
  }
})
```

### 🏠 获取房源列表
```javascript
// 获取房源列表
wx.request({
  url: 'http://localhost:3000/houses',
  method: 'GET',
  data: {
    page: 1,
    pageSize: 10,
    area: '西湖区',  // 可选筛选条件
    priceMin: 200,   // 可选
    priceMax: 400    // 可选
  },
  success: (res) => {
    console.log('房源列表:', res.data.data.list)
    console.log('分页信息:', res.data.data.pagination)
  }
})
```

### 🏡 获取房源详情
```javascript
// 获取房源详情
const houseId = '660e8400-e29b-41d4-a716-446655440001'
wx.request({
  url: `http://localhost:3000/houses/${houseId}`,
  method: 'GET',
  success: (res) => {
    console.log('房源详情:', res.data.data)
  }
})
```

### ❤️ 收藏功能
```javascript
// 添加收藏 (需要登录)
const token = wx.getStorageSync('token')
wx.request({
  url: `http://localhost:3000/user/collections/${houseId}`,
  method: 'POST',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    wx.showToast({ title: '收藏成功' })
  }
})

// 取消收藏
wx.request({
  url: `http://localhost:3000/user/collections/${houseId}`,
  method: 'DELETE',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    wx.showToast({ title: '取消收藏成功' })
  }
})

// 检查收藏状态
wx.request({
  url: `http://localhost:3000/user/collections/${houseId}/status`,
  method: 'GET',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    const isCollected = res.data.data.isCollected
    console.log('是否已收藏:', isCollected)
  }
})
```

### 📋 获取收藏列表
```javascript
// 获取用户收藏列表
wx.request({
  url: 'http://localhost:3000/user/collections',
  method: 'GET',
  header: {
    'Authorization': `Bearer ${token}`
  },
  data: {
    page: 1,
    pageSize: 10
  },
  success: (res) => {
    console.log('收藏列表:', res.data.data.list)
  }
})
```

### 👤 用户信息
```javascript
// 获取用户信息
wx.request({
  url: 'http://localhost:3000/user/profile',
  method: 'GET',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    console.log('用户信息:', res.data.data)
  }
})

// 更新用户信息
wx.request({
  url: 'http://localhost:3000/user/profile',
  method: 'PUT',
  header: {
    'Authorization': `Bearer ${token}`
  },
  data: {
    nickname: '新昵称',
    phone: '13800138001',
    realName: '真实姓名'
  },
  success: (res) => {
    wx.showToast({ title: '更新成功' })
  }
})
```

## 测试数据

### 测试用户信息
可以使用以下测试用户进行登录测试：

| 昵称 | OpenID | 手机号 | 真实姓名 |
|------|--------|--------|----------|
| 张小明 | wx_openid_001 | 13800138001 | 张明 |
| 李小红 | wx_openid_002 | 13800138002 | 李红 |
| 王大华 | wx_openid_003 | 13800138003 | 王华 |
| 陈小美 | wx_openid_004 | 13800138004 | 陈美 |
| 刘小强 | wx_openid_005 | 13800138005 | 刘强 |

### 测试房源
系统预置了6个测试房源：

1. **西湖印象花园** (ID: 660e8400-e29b-41d4-a716-446655440001)
   - 区域: 西湖区
   - 价格: 280万
   - 特色: 学区房、地铁沟通

2. **钱江新城公寓** (ID: 660e8400-e29b-41d4-a716-446655440002)
   - 区域: 上城区
   - 价格: 350万
   - 特色: 江景房、CBD核心

3. **滨江科技城** (ID: 660e8400-e29b-41d4-a716-446655440003)
   - 区域: 滨江区
   - 价格: 420万
   - 特色: 科技园区、配套齐全

## 通用工具函数

### 请求封装
```javascript
// utils/request.js
const baseURL = 'http://localhost:3000'

function request(options) {
  const token = wx.getStorageSync('token')
  
  return new Promise((resolve, reject) => {
    wx.request({
      url: baseURL + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      },
      success: (res) => {
        if (res.data.code === 200) {
          resolve(res.data)
        } else {
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          })
          reject(res.data)
        }
      },
      fail: (err) => {
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        })
        reject(err)
      }
    })
  })
}

module.exports = { request }
```

### API封装示例
```javascript
// api/house.js
const { request } = require('../utils/request')

// 获取房源列表
function getHouseList(params) {
  return request({
    url: '/houses',
    data: params
  })
}

// 获取房源详情
function getHouseDetail(id) {
  return request({
    url: `/houses/${id}`
  })
}

// 收藏房源
function collectHouse(houseId) {
  return request({
    url: `/user/collections/${houseId}`,
    method: 'POST'
  })
}

// 取消收藏
function uncollectHouse(houseId) {
  return request({
    url: `/user/collections/${houseId}`,
    method: 'DELETE'
  })
}

module.exports = {
  getHouseList,
  getHouseDetail,
  collectHouse,
  uncollectHouse
}
```

## 常见问题

### Q1: 如何处理Token过期？
```javascript
// 在请求失败时检查是否为401错误
if (res.statusCode === 401) {
  // Token过期，重新登录
  wx.removeStorageSync('token')
  wx.navigateTo({
    url: '/pages/login/login'
  })
}
```

### Q2: 如何处理图片显示？
```javascript
// 小程序中显示图片
<image src="{{house.coverImage}}" mode="aspectFill" />

// 如果图片加载失败，可以设置默认图片
<image 
  src="{{house.coverImage || '/images/default-house.png'}}" 
  mode="aspectFill"
  binderror="onImageError"
/>
```

### Q3: 如何实现下拉刷新和上拉加载？
```javascript
// 页面配置
{
  "enablePullDownRefresh": true,
  "onReachBottomDistance": 50
}

// 页面逻辑
Page({
  data: {
    houseList: [],
    page: 1,
    hasMore: true
  },
  
  // 下拉刷新
  onPullDownRefresh() {
    this.setData({
      page: 1,
      houseList: []
    })
    this.loadHouseList()
  },
  
  // 上拉加载
  onReachBottom() {
    if (this.data.hasMore) {
      this.loadHouseList()
    }
  },
  
  // 加载房源列表
  async loadHouseList() {
    try {
      const res = await getHouseList({
        page: this.data.page,
        pageSize: 10
      })
      
      const newList = this.data.page === 1 ? 
        res.data.list : 
        [...this.data.houseList, ...res.data.list]
      
      this.setData({
        houseList: newList,
        page: this.data.page + 1,
        hasMore: res.data.pagination.page < res.data.pagination.totalPages
      })
      
      wx.stopPullDownRefresh()
    } catch (error) {
      console.error('加载失败:', error)
    }
  }
})
```

## 调试技巧

### 1. 使用微信开发者工具网络面板
- 打开调试器 → Network 面板
- 查看请求和响应详情
- 检查请求头是否正确

### 2. 服务器日志
```bash
# 查看服务器实时日志
npm run dev
```

### 3. 数据库查看
- 访问 http://localhost:8080
- 登录信息：服务器=house-postgres，用户名=postgres，密码=postgres123
- 可以直接查看和修改数据

## 联系支持

如果在联调过程中遇到问题：
1. 查看API文档：http://localhost:3000/docs
2. 检查服务器日志
3. 使用Postman等工具测试接口
4. 联系后端开发团队

祝联调顺利！🎉