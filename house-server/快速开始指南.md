# 杭州保障房小程序后端快速开始指南

基于推荐的 **Fastify + PostgreSQL + Redis** 技术栈

## 1. 环境准备

### 1.1 系统要求
- Node.js >= 18.0.0
- Docker & Docker Compose
- Git

### 1.2 安装依赖

```bash
# 检查 Node.js 版本
node --version

# 检查 Docker 版本
docker --version
docker-compose --version
```

## 2. 项目初始化

### 2.1 创建项目目录

```bash
mkdir house-api
cd house-api
```

### 2.2 初始化 package.json

```bash
npm init -y
```

### 2.3 安装核心依赖

```bash
# 生产依赖
npm install fastify @fastify/cors @fastify/helmet @fastify/jwt @fastify/multipart @fastify/postgres @fastify/redis @fastify/swagger @fastify/swagger-ui pg redis bcrypt axios sharp node-cron pino

# 开发依赖
npm install -D @types/node @types/pg @types/bcrypt typescript ts-node nodemon jest @types/jest ts-jest eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin prettier
```

### 2.4 配置 TypeScript

创建 `tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### 2.5 配置 package.json 脚本

```json
{
  "scripts": {
    "dev": "nodemon --exec ts-node src/app.ts",
    "build": "tsc",
    "start": "node dist/app.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "lint": "eslint src/**/*.ts",
    "lint:fix": "eslint src/**/*.ts --fix",
    "format": "prettier --write src/**/*.ts"
  }
}
```

## 3. 项目结构搭建

### 3.1 创建目录结构

```bash
mkdir -p src/{controllers,services,models,schemas,plugins,utils,config,types}
mkdir -p {migrations,seeds,tests,docs}
```

### 3.2 创建环境配置

创建 `.env` 文件:

```env
# 应用配置
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# JWT 配置
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRES_IN=7d

# 数据库配置
DATABASE_URL=postgresql://postgres:password@localhost:5432/house_db
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=house_db
DATABASE_USER=postgres
DATABASE_PASSWORD=password

# Redis 配置
REDIS_URL=redis://localhost:6379
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 微信小程序配置
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret

# 文件上传配置
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760

# 加密密钥
ENCRYPT_KEY=your-encrypt-key-32-characters

# 日志配置
LOG_LEVEL=info
```

创建 `.env.example` 文件（复制 `.env` 内容，移除敏感信息）

## 4. 核心代码实现

### 4.1 应用入口 (`src/app.ts`)

```typescript
import Fastify from 'fastify';
import { config } from './config/app';
import { registerPlugins } from './plugins';
import { registerRoutes } from './controllers';

const fastify = Fastify({
  logger: {
    level: config.logLevel,
    transport: {
      target: 'pino-pretty',
      options: {
        colorize: true,
        translateTime: 'SYS:standard'
      }
    }
  }
});

async function start() {
  try {
    // 注册插件
    await registerPlugins(fastify);
    
    // 注册路由
    await registerRoutes(fastify);
    
    // 启动服务器
    await fastify.listen({
      port: config.port,
      host: config.host
    });
    
    console.log(`🚀 Server running at http://${config.host}:${config.port}`);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
}

start();
```

### 4.2 应用配置 (`src/config/app.ts`)

```typescript
import dotenv from 'dotenv';

dotenv.config();

export const config = {
  // 应用配置
  nodeEnv: process.env.NODE_ENV || 'development',
  port: parseInt(process.env.PORT || '3000'),
  host: process.env.HOST || '0.0.0.0',
  logLevel: process.env.LOG_LEVEL || 'info',
  
  // JWT 配置
  jwt: {
    secret: process.env.JWT_SECRET || 'default-secret',
    expiresIn: process.env.JWT_EXPIRES_IN || '7d'
  },
  
  // 数据库配置
  database: {
    url: process.env.DATABASE_URL,
    host: process.env.DATABASE_HOST || 'localhost',
    port: parseInt(process.env.DATABASE_PORT || '5432'),
    name: process.env.DATABASE_NAME || 'house_db',
    user: process.env.DATABASE_USER || 'postgres',
    password: process.env.DATABASE_PASSWORD || 'password'
  },
  
  // Redis 配置
  redis: {
    url: process.env.REDIS_URL,
    host: process.env.REDIS_HOST || 'localhost',
    port: parseInt(process.env.REDIS_PORT || '6379'),
    password: process.env.REDIS_PASSWORD
  },
  
  // 微信配置
  wechat: {
    appId: process.env.WECHAT_APP_ID,
    appSecret: process.env.WECHAT_APP_SECRET
  },
  
  // 文件上传配置
  upload: {
    path: process.env.UPLOAD_PATH || './uploads',
    maxFileSize: parseInt(process.env.MAX_FILE_SIZE || '10485760')
  },
  
  // 加密配置
  encryptKey: process.env.ENCRYPT_KEY || 'default-encrypt-key-32-characters'
};
```

### 4.3 数据库插件 (`src/plugins/database.plugin.ts`)

```typescript
import fp from 'fastify-plugin';
import postgres from '@fastify/postgres';
import { config } from '../config/app';

export default fp(async function (fastify) {
  await fastify.register(postgres, {
    connectionString: config.database.url,
    ssl: config.nodeEnv === 'production' ? { rejectUnauthorized: false } : false
  });
  
  // 测试数据库连接
  try {
    const client = await fastify.pg.connect();
    const { rows } = await client.query('SELECT NOW()');
    fastify.log.info(`✅ Database connected at ${rows[0].now}`);
    client.release();
  } catch (err) {
    fastify.log.error('❌ Database connection failed:', err);
    throw err;
  }
});
```

### 4.4 Redis 插件 (`src/plugins/redis.plugin.ts`)

```typescript
import fp from 'fastify-plugin';
import redis from '@fastify/redis';
import { config } from '../config/app';

export default fp(async function (fastify) {
  await fastify.register(redis, {
    host: config.redis.host,
    port: config.redis.port,
    password: config.redis.password,
    retryDelayOnFailover: 100,
    maxRetriesPerRequest: 3
  });
  
  // 测试 Redis 连接
  try {
    await fastify.redis.ping();
    fastify.log.info('✅ Redis connected');
  } catch (err) {
    fastify.log.error('❌ Redis connection failed:', err);
    throw err;
  }
});
```

### 4.5 插件注册 (`src/plugins/index.ts`)

```typescript
import { FastifyInstance } from 'fastify';
import cors from '@fastify/cors';
import helmet from '@fastify/helmet';
import swagger from '@fastify/swagger';
import swaggerUi from '@fastify/swagger-ui';
import multipart from '@fastify/multipart';
import jwt from '@fastify/jwt';

import databasePlugin from './database.plugin';
import redisPlugin from './redis.plugin';
import authPlugin from './auth.plugin';
import { config } from '../config/app';

export async function registerPlugins(fastify: FastifyInstance) {
  // CORS
  await fastify.register(cors, {
    origin: true,
    credentials: true
  });
  
  // 安全头
  await fastify.register(helmet);
  
  // JWT
  await fastify.register(jwt, {
    secret: config.jwt.secret
  });
  
  // 文件上传
  await fastify.register(multipart, {
    limits: {
      fileSize: config.upload.maxFileSize
    }
  });
  
  // Swagger 文档
  await fastify.register(swagger, {
    swagger: {
      info: {
        title: '杭州保障房小程序 API',
        description: 'API 接口文档',
        version: '1.0.0'
      },
      host: `${config.host}:${config.port}`,
      schemes: ['http', 'https'],
      consumes: ['application/json'],
      produces: ['application/json'],
      securityDefinitions: {
        Bearer: {
          type: 'apiKey',
          name: 'Authorization',
          in: 'header'
        }
      }
    }
  });
  
  await fastify.register(swaggerUi, {
    routePrefix: '/docs',
    uiConfig: {
      docExpansion: 'full',
      deepLinking: false
    }
  });
  
  // 数据库
  await fastify.register(databasePlugin);
  
  // Redis
  await fastify.register(redisPlugin);
  
  // 认证
  await fastify.register(authPlugin);
}
```

### 4.6 房源控制器示例 (`src/controllers/house.controller.ts`)

```typescript
import { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import { HouseService } from '../services/house.service';
import { houseListSchema, houseDetailSchema } from '../schemas/house.schema';

export async function houseRoutes(fastify: FastifyInstance) {
  const houseService = new HouseService(fastify);
  
  // 获取房源列表
  fastify.get('/houses', {
    schema: houseListSchema,
    preHandler: [fastify.authenticate]
  }, async (request: FastifyRequest<{
    Querystring: {
      page?: number;
      limit?: number;
      area?: string;
      priceMin?: number;
      priceMax?: number;
      keyword?: string;
    }
  }>, reply: FastifyReply) => {
    try {
      const result = await houseService.getHouseList(request.query);
      return {
        code: 200,
        message: '获取成功',
        data: result
      };
    } catch (error) {
      fastify.log.error(error);
      return reply.code(500).send({
        code: 500,
        message: '服务器内部错误'
      });
    }
  });
  
  // 获取房源详情
  fastify.get('/houses/:id', {
    schema: houseDetailSchema,
    preHandler: [fastify.authenticate]
  }, async (request: FastifyRequest<{
    Params: { id: string }
  }>, reply: FastifyReply) => {
    try {
      const house = await houseService.getHouseDetail(request.params.id);
      if (!house) {
        return reply.code(404).send({
          code: 404,
          message: '房源不存在'
        });
      }
      
      return {
        code: 200,
        message: '获取成功',
        data: house
      };
    } catch (error) {
      fastify.log.error(error);
      return reply.code(500).send({
        code: 500,
        message: '服务器内部错误'
      });
    }
  });
}
```

## 5. Docker 环境搭建

### 5.1 创建 docker-compose.yml

```yaml
version: '3.8'

services:
  postgres:
    image: postgis/postgis:15-3.3
    container_name: house-postgres
    environment:
      POSTGRES_DB: house_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    networks:
      - house-network

  redis:
    image: redis:7-alpine
    container_name: house-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - house-network

  adminer:
    image: adminer
    container_name: house-adminer
    ports:
      - "8080:8080"
    networks:
      - house-network
    depends_on:
      - postgres

volumes:
  postgres_data:
  redis_data:

networks:
  house-network:
    driver: bridge
```

### 5.2 启动开发环境

```bash
# 启动数据库和 Redis
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

## 6. 数据库初始化

### 6.1 创建初始化脚本 (`migrations/001_init.sql`)

```sql
-- 启用 PostGIS 扩展
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    openid VARCHAR(100) UNIQUE NOT NULL,
    unionid VARCHAR(100),
    nickname VARCHAR(100),
    avatar TEXT,
    phone VARCHAR(20),
    real_name VARCHAR(50),
    id_card VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 房源表
CREATE TABLE houses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    cover_image TEXT,
    images JSONB,
    price DECIMAL(10,2),
    price_unit VARCHAR(10) DEFAULT '万',
    area VARCHAR(100),
    address TEXT,
    location GEOMETRY(POINT, 4326),
    house_types JSONB,
    delivery_time VARCHAR(50),
    tags JSONB,
    rating DECIMAL(3,2) DEFAULT 0,
    developer VARCHAR(200),
    property_company VARCHAR(200),
    building_area DECIMAL(10,2),
    plot_ratio DECIMAL(5,2),
    green_rate DECIMAL(5,2),
    parking_ratio VARCHAR(20),
    school_district VARCHAR(200),
    description TEXT,
    nearby_facilities JSONB,
    pros JSONB,
    cons JSONB,
    floor_plans JSONB,
    sales_info JSONB,
    status VARCHAR(20) DEFAULT 'available',
    view_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_houses_location ON houses USING GIST (location);
CREATE INDEX idx_houses_area ON houses (area);
CREATE INDEX idx_houses_price ON houses (price);
CREATE INDEX idx_houses_status ON houses (status);
CREATE INDEX idx_users_openid ON users (openid);

-- 插入测试数据
INSERT INTO houses (name, price, area, address, location, description) VALUES
('杭州保障房项目A', 280.00, '西湖区', '杭州市西湖区文三路123号', ST_GeomFromText('POINT(120.1551 30.2741)', 4326), '优质保障房项目，交通便利'),
('杭州保障房项目B', 320.00, '江干区', '杭州市江干区钱江路456号', ST_GeomFromText('POINT(120.2051 30.2541)', 4326), '现代化小区，配套完善'),
('杭州保障房项目C', 250.00, '拱墅区', '杭州市拱墅区莫干山路789号', ST_GeomFromText('POINT(120.1351 30.3041)', 4326), '地铁沿线，出行方便');
```

## 7. 启动项目

### 7.1 安装依赖并启动

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 7.2 验证服务

```bash
# 检查 API 健康状态
curl http://localhost:3000/health

# 访问 API 文档
open http://localhost:3000/docs

# 访问数据库管理界面
open http://localhost:8080
```

## 8. 开发工具配置

### 8.1 VSCode 配置 (`.vscode/settings.json`)

```json
{
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.exclude": {
    "**/node_modules": true,
    "**/dist": true
  }
}
```

### 8.2 推荐的 VSCode 扩展

创建 `.vscode/extensions.json`:

```json
{
  "recommendations": [
    "ms-vscode.vscode-typescript-next",
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "ms-vscode.vscode-json",
    "bradlc.vscode-tailwindcss",
    "ms-vscode-remote.remote-containers",
    "ckolkman.vscode-postgres"
  ]
}
```

## 9. 测试配置

### 9.1 Jest 配置 (`jest.config.js`)

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  transform: {
    '^.+\.ts$': 'ts-jest'
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/app.ts'
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html']
};
```

### 9.2 示例测试文件 (`tests/house.test.ts`)

```typescript
import { build } from '../src/app';

describe('House API', () => {
  let app: any;
  
  beforeAll(async () => {
    app = build({ logger: false });
    await app.ready();
  });
  
  afterAll(async () => {
    await app.close();
  });
  
  test('GET /api/houses should return house list', async () => {
    const response = await app.inject({
      method: 'GET',
      url: '/api/houses',
      headers: {
        authorization: 'Bearer valid-token'
      }
    });
    
    expect(response.statusCode).toBe(200);
    expect(response.json()).toHaveProperty('data');
  });
});
```

## 10. 部署准备

### 10.1 生产环境配置

创建 `.env.production`:

```env
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# 生产环境数据库配置
DATABASE_URL=postgresql://user:password@prod-db:5432/house_db

# 生产环境 Redis 配置
REDIS_URL=redis://prod-redis:6379

# 强密钥
JWT_SECRET=your-super-strong-jwt-secret-for-production
ENCRYPT_KEY=your-super-strong-encrypt-key-32-chars

# 微信生产环境配置
WECHAT_APP_ID=your-production-app-id
WECHAT_APP_SECRET=your-production-app-secret

# 日志级别
LOG_LEVEL=warn
```

### 10.2 构建脚本

```bash
# 构建生产版本
npm run build

# 启动生产服务
npm start
```

## 11. 常见问题解决

### 11.1 数据库连接问题

```bash
# 检查 PostgreSQL 服务状态
docker-compose ps postgres

# 查看 PostgreSQL 日志
docker-compose logs postgres

# 重启 PostgreSQL
docker-compose restart postgres
```

### 11.2 Redis 连接问题

```bash
# 检查 Redis 服务状态
docker-compose ps redis

# 测试 Redis 连接
docker-compose exec redis redis-cli ping
```

### 11.3 端口占用问题

```bash
# 查看端口占用
lsof -i :3000
lsof -i :5432
lsof -i :6379

# 修改 docker-compose.yml 中的端口映射
```

## 12. 下一步开发

1. **完善业务逻辑**: 根据接口文档实现具体的业务功能
2. **添加单元测试**: 为每个服务和控制器编写测试
3. **集成微信 API**: 实现微信登录和支付功能
4. **优化性能**: 添加缓存策略和数据库查询优化
5. **部署上线**: 配置 CI/CD 流程和生产环境

---

🎉 **恭喜！** 你已经成功搭建了杭州保障房小程序的后端开发环境。

如有问题，请参考：
- [Fastify 官方文档](https://www.fastify.io/docs/)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Redis 文档](https://redis.io/documentation)
- [Docker 文档](https://docs.docker.com/)